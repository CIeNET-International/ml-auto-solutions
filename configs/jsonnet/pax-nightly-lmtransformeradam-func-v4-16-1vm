{
   "accelerator": {
      "name": "v4-16",
      "numCores": 4,
      "replicas": 2,
      "size": 16,
      "type": "tpu",
      "variant": "",
      "version": 4
   },
   "command": [
      "bash",
      "-c",
      "set -x\nset -u\n\ncat > testsetup.sh << 'TEST_SCRIPT_EOF'\nset -x\nset -u\nset -e\n\n# .bash_logout sometimes causes a spurious bad exit code, remove it.\nrm .bash_logout\n\n# check for nightly build\ngsutil cp gs://pax-on-cloud-tpu-project/wheels/$(date +%Y%m%d)/paxml*.whl .\ngsutil cp gs://pax-on-cloud-tpu-project/wheels/$(date +%Y%m%d)/praxis*.whl .\n\nif [ -f praxis*.whl -a -f paxml*.whl ]; then\n    echo \"Nightly builds succeeded.\"\nelse \n    echo \"Nighlty builds failed or are pending.\"\n    exit 1\nfi \n\n# install Pax and dependencies\npip install praxis*.whl\npip install paxml*.whl\nsudo pip uninstall --yes jax jaxlib libtpu-nightly\n\npip install git+https://github.com/google/jax.git\npip install --pre -U jaxlib -f https://storage.googleapis.com/jax-releases/jaxlib_nightly_releases.html\npip install --no-index -U libtpu-nightly -f https://storage.googleapis.com/jax-releases/libtpu_releases.html\n\nnum_devices=`python3 -c \"import jax; print(jax.device_count())\"`\necho \"num_devices: $num_devices\"\nif [ \"$num_devices\" = \"1\" ]; then\n    echo \"No TPU devices detected\"\n    exit 1\nfi\n\npython3 .local/lib/python3.10/site-packages/paxml/main.py --exp=tasks.lm.params.lm_cloud.LmCloudTransformerAdamLimitSteps --job_log_dir=$(MODEL_DIR) --jax_fully_async_checkpoint=False --pmap_use_tensorstore=True\n\nTEST_SCRIPT_EOF\n\ngcloud alpha compute tpus tpu-vm ssh xl-ml-test@$(cat /scripts/tpu_name) \\\n--zone=$(cat /scripts/zone) \\\n--ssh-key-file=/scripts/id_rsa \\\n--strict-host-key-checking=no \\\n--internal-ip \\\n--worker=all \\\n--command \"$(cat testsetup.sh)\"\n\nexit_code=$?\nbash /scripts/cleanup.sh\nexit $exit_code\n"
   ],
   "configMaps": [
      "gcs-buckets"
   ],
   "cpu": 1,
   "entrypoint": null,
   "frameworkPrefix": "pax-nightly",
   "image": null,
   "imageTag": "latest",
   "labels": {
      "accelerator": "v4-16",
      "benchmarkId": "pax-nightly-lmtransformeradam-func-v4-16-1vm",
      "frameworkVersion": "pax-nightly",
      "mode": "func",
      "model": "lmtransformeradam"
   },
   "memory": "2Gi",
   "metricConfig": {
      "sources": [
         {
            "tensorboard": {
               "aggregate_assertions": [ ],
               "exclude_tags": [ ],
               "include_tags": [
                  {
                     "strategies": [
                        "FINAL"
                     ],
                     "tag_pattern": "*"
                  }
               ],
               "merge_runs": false
            }
         }
      ]
   },
   "mode": "func",
   "modelName": "lmtransformeradam",
   "outputBucket": "$(OUTPUT_BUCKET)",
   "schedule": "0 11 * * *",
   "testName": "pax-nightly-lmtransformeradam-func-v4-16-1vm",
   "timeout": 3600,
   "tpuSettings": {
      "preemptible": true,
      "requireTpuAvailableLabel": true,
      "reserved": "false",
      "softwareVersion": "tpu-ubuntu2204-base",
      "tpuVmCreateSleepSeconds": 60,
      "tpuVmDockerArgs": "",
      "tpuVmStartupScript": "echo Running startup script"
   },
   "volumeMap": {
      "scripts": {
         "claim": {
            "emptyDir": {
               "medium": "Memory"
            }
         },
         "mountPath": "/scripts",
         "name": "scripts",
         "readOnly": false
      }
   }
}
