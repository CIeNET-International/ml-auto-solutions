{
   "accelerator": {
      "name": "v3-32",
      "numCores": 8,
      "replicas": 4,
      "size": 32,
      "type": "tpu",
      "variant": "",
      "version": 3
   },
   "command": [
      "bash",
      "-c",
      "set -x\nset -u\n\ncat > testsetup.sh << 'TEST_SCRIPT_EOF'\nset -x\nset -u\nset -e\n\n# .bash_logout sometimes causes a spurious bad exit code, remove it.\nrm .bash_logout\n\npip install --upgrade pip\ngit clone https://github.com/huggingface/transformers.git\ncd transformers && pip install .\npip install -r examples/flax/_tests_requirements.txt\npip install --upgrade huggingface-hub urllib3 zipp\n\npip install tensorflow\npip install jax[tpu] -f https://storage.googleapis.com/jax-releases/libtpu_releases.html\n\npip install -r examples/flax/vision/requirements.txt\npython3 -c 'import flax; print(\"flax version:\", flax.__version__)'\nnum_devices=`python3 -c \"import jax; print(jax.device_count())\"`\nif [ \"$num_devices\" = \"1\" ]; then\n  echo \"No TPU devices detected\"\n  exit 1\nfi\n\n\nwget https://s3.amazonaws.com/fast-ai-imageclas/imagenette2.tgz\ntar -xvzf imagenette2.tgz\n\nexport GCS_BUCKET=$(MODEL_DIR)\npython3 examples/flax/vision/run_image_classification.py \\\n  --output_dir './vit-imagenette' \\\n  --train_dir='imagenette2/train' \\\n  --validation_dir='imagenette2/val' \\\n  --learning_rate 1e-3 \\\n  --preprocessing_num_workers 32 \\\n  --model_name_or_path google/vit-base-patch16-224-in21k --num_train_epochs 30 --per_device_train_batch_size 32 --per_device_eval_batch_size 32\n\n# Ignore CommandException for the rest workers in TPU pod\ngsutil -m cp -r ./vit-imagenette $(MODEL_DIR) || exit 0\n\n\nTEST_SCRIPT_EOF\n\ngcloud alpha compute tpus tpu-vm ssh xl-ml-test@$(cat /scripts/tpu_name) \\\n--zone=$(cat /scripts/zone) \\\n--ssh-key-file=/scripts/id_rsa \\\n--strict-host-key-checking=no \\\n--internal-ip \\\n--worker=all \\\n--command \"$(cat testsetup.sh)\"\n\nexit_code=$?\nbash /scripts/cleanup.sh\nexit $exit_code\n"
   ],
   "configMaps": [
      "gcs-buckets"
   ],
   "cpu": 1,
   "entrypoint": null,
   "frameworkPrefix": "flax.latest",
   "image": "google/cloud-sdk",
   "imageTag": "latest",
   "labels": {
      "accelerator": "v3-32",
      "benchmarkId": "flax.latest-vit-imagenette-conv-v3-32-1vm",
      "frameworkVersion": "flax.latest",
      "mode": "conv",
      "model": "vit-imagenette"
   },
   "memory": "2Gi",
   "metricConfig": {
      "sources": [
         {
            "tensorboard": {
               "aggregate_assertions": [
                  {
                     "assertion": {
                        "fixed_value": {
                           "comparison": "GREATER",
                           "value": 0.97999999999999998
                        },
                        "inclusive_bounds": false,
                        "wait_for_n_data_points": 0
                     },
                     "strategy": "FINAL",
                     "tag": "eval_accuracy"
                  }
               ],
               "exclude_tags": [
                  "_hparams_/session_start_info"
               ],
               "include_tags": [
                  {
                     "strategies": [
                        "FINAL"
                     ],
                     "tag_pattern": "*"
                  }
               ],
               "merge_runs": true
            }
         }
      ]
   },
   "mode": "conv",
   "outputBucket": "$(OUTPUT_BUCKET)",
   "runTest": "export GCS_BUCKET=$(MODEL_DIR)\npython3 examples/flax/vision/run_image_classification.py \\\n  --output_dir './vit-imagenette' \\\n  --train_dir='imagenette2/train' \\\n  --validation_dir='imagenette2/val' \\\n  --learning_rate 1e-3 \\\n  --preprocessing_num_workers 32 \\\n  --model_name_or_path google/vit-base-patch16-224-in21k --num_train_epochs 30 --per_device_train_batch_size 32 --per_device_eval_batch_size 32\n\n# Ignore CommandException for the rest workers in TPU pod\ngsutil -m cp -r ./vit-imagenette $(MODEL_DIR) || exit 0\n",
   "schedule": "0 6 * * 0,5",
   "setup": "pip install --upgrade pip\ngit clone https://github.com/huggingface/transformers.git\ncd transformers && pip install .\npip install -r examples/flax/_tests_requirements.txt\npip install --upgrade huggingface-hub urllib3 zipp\n\npip install tensorflow\npip install jax[tpu] -f https://storage.googleapis.com/jax-releases/libtpu_releases.html\n\npip install -r examples/flax/vision/requirements.txt\npython3 -c 'import flax; print(\"flax version:\", flax.__version__)'\nnum_devices=`python3 -c \"import jax; print(jax.device_count())\"`\nif [ \"$num_devices\" = \"1\" ]; then\n  echo \"No TPU devices detected\"\n  exit 1\nfi\n\n\nwget https://s3.amazonaws.com/fast-ai-imageclas/imagenette2.tgz\ntar -xvzf imagenette2.tgz\n",
   "testName": "flax.latest-vit-imagenette-conv-v3-32-1vm",
   "timeout": 36000,
   "tpuSettings": {
      "preemptible": false,
      "requireTpuAvailableLabel": true,
      "reserved": "false",
      "softwareVersion": "tpu-ubuntu2204-base",
      "tpuVmCreateSleepSeconds": 60,
      "tpuVmDockerArgs": "",
      "tpuVmStartupScript": "echo Running startup script"
   },
   "volumeMap": {
      "scripts": {
         "claim": {
            "emptyDir": {
               "medium": "Memory"
            }
         },
         "mountPath": "/scripts",
         "name": "scripts",
         "readOnly": false
      }
   }
}
